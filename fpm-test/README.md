# Fixed-Point Math Test

Simple C++ program for testing temperature coefficient fixed point math.

## Compensation Algorithm

The temperature compenstation is performed using a piece-wise-linear estimation of the DCXO drift vs temperature.  The
temperature is binned by the truncated value in Celsius.  The temperature value is also recentered around the mid-point of the bin.

```C++
binId = floor(celsius)
x = celsius - bindId - 0.5
```

Each bin has five accumulator cells for performing a linear OLS fit which are updated using an [EMA](https://en.wikipedia.org/wiki/Moving_average#Exponential_moving_average):
- norm = accumulates unitary value for matrix normalization (equivalent to XX[1,1])
- A = the [0,0] cell of the XX matrix (accumulates X * X)
- B = the [1,0] cell of the XX matrix (accumulates X * 1)
- C = the [0,0] cell of the XY matrix (accumulates Y * X)
- D = the [1,0] cell of the XY matrix (accumulates Y * 1)

To compute the correction coefficients, the four cell values are first normalized by dividing them by the norm value.  The correction coefficients are then computed as follows:

```C++
// Z is the determinant of XX matrix
Z = (A * 1) - (B * B)

// expanded product of inverse XX matrix and XY matrix
m = ((C * 1) - (B * D)) / Z;
b = ((A * D) - (B * C)) / Z;
```

The coefficients are then applied in standard `y=mx+b` form to compute the frequency offset for the DCXO.

## InfluxDB Export

Data set exported as `gpsdo.csv`. Truncated example available as `gpsdo.short.csv`.

Query:
```
SELECT mean("temperature") AS "temp", mean("pll_ppm") AS "ppm", max("pll_rmse") AS "error" FROM "gpsdo" WHERE time >= now() - 365d GROUP BY time(11s) fill(null)
```

## Results

The RMSE error of temperature compensation is 2.81 ppb.  Worst compensation error is 24.5 ppb.  Long-term bias is 0.085 ppb.

```
loaded 2844044 data samples

biasI: -0.000085 ppm
biasF: -0.000099 ppm
rmseI: 0.002806 ppm (0.024494 ppm) [0]
rmseF: 0.002806 ppm (0.024500 ppm) [0]

fixed point math:
Temp.   Count        Norm       X * X       X * 1       Y * X       Y * 1           m           b
 32:        1    0.000008    0.009537    0.097656   -0.041818   -0.428220    0.000000   -0.428220
 33:        2    0.000015    0.090469   -0.300766    0.134798   -0.448136    0.000000   -0.448136
 34:        5    0.000038    0.103813   -0.081238    0.038182   -0.479778    0.000000   -0.479778
 35:        3    0.000023    0.096303    0.098953   -0.050733   -0.495196    0.000000   -0.495196
 36:        4    0.000031    0.107149   -0.125961    0.063210   -0.510328    0.000000   -0.510328
 37:        2    0.000015    0.160315   -0.001938   -0.002396   -0.527644    0.000000   -0.527644
 38:        7    0.000053    0.113261   -0.130569    0.069036   -0.540020    0.000000   -0.540020
 39:        3    0.000023    0.019847    0.065094   -0.036869   -0.562900    0.000000   -0.562900
 40:        4    0.000031    0.129184   -0.051758    0.027845   -0.577772    0.000000   -0.577772
 41:      166    0.001265    0.091629    0.209671   -0.122575   -0.582296   -0.010164   -0.580164
 42:     5573    0.040762    0.076521    0.181381   -0.109654   -0.600548   -0.016642   -0.597506
 43:    31834    0.192386    0.081230    0.053406   -0.033896   -0.612950   -0.014810   -0.612144
 44:    95979    0.384413    0.082131   -0.016937    0.009356   -0.627328   -0.015502   -0.627588
 45:   146660    0.446664    0.085254   -0.065338    0.040772   -0.641810   -0.014351   -0.642746
 46:   148095    0.447819    0.086034   -0.025864    0.015695   -0.657358   -0.015312   -0.657748
 47:   204704    0.478007    0.079456   -0.031265    0.019989   -0.671320   -0.012745   -0.671710
 48:   252446    0.489389    0.076883    0.035782   -0.025384   -0.684060   -0.011997   -0.683618
 49:   327094    0.496608    0.081477   -0.005478    0.002702   -0.696852   -0.013691   -0.696904
 50:   376558    0.498410    0.080922   -0.025299    0.016903   -0.709592   -0.013061   -0.709904
 51:   425167    0.499246    0.086530   -0.099182    0.070679   -0.721318   -0.011255   -0.722410
 52:   285106    0.493557    0.092813   -0.079361    0.057185   -0.733356   -0.011734   -0.734266
 53:   228014    0.484592    0.082412   -0.055069    0.040177   -0.744640   -0.010454   -0.745212
 54:   196940    0.475240    0.090037   -0.034500    0.025013   -0.756080   -0.012066   -0.756496
 55:   113274    0.411225    0.104833   -0.206009    0.157016   -0.764972   -0.009222   -0.766870
 56:     5711    0.041728    0.131756   -0.222610    0.171476   -0.773786   -0.009450   -0.775866
 57:      518    0.003937    0.175686   -0.407883    0.318258   -0.780286   -0.000814   -0.780598

floating point math:
Temp.   Count        Norm       X * X       X * 1       Y * X       Y * 1           m           b
 32:        1    0.000015    0.010000    0.099998   -0.042819   -0.428200    0.000000   -0.428200
 33:        2    0.000031    0.090000   -0.299999    0.134445   -0.448150    0.000000   -0.448150
 34:        5    0.000076    0.103999   -0.079993    0.037579   -0.479780    0.000000   -0.479780
 35:        3    0.000046    0.096668    0.100002   -0.051251   -0.495200    0.000000   -0.495200
 36:        4    0.000061    0.107499   -0.124995    0.062705   -0.510325    0.000000   -0.510325
 37:        2    0.000031    0.160001    0.000003   -0.003422   -0.527650    0.000000   -0.527650
 38:        7    0.000107    0.112857   -0.128565    0.067949   -0.540043    0.000000   -0.540043
 39:        3    0.000046    0.020000    0.066668   -0.037748   -0.562900    0.000000   -0.562900
 40:        4    0.000061    0.130000   -0.050005    0.026820   -0.577775    0.000000   -0.577775
 41:      166    0.002530    0.092415    0.211462   -0.123611   -0.582304   -0.009975   -0.580195
 42:     5573    0.081523    0.077241    0.183138   -0.110707   -0.600556   -0.016523   -0.597530
 43:    31834    0.384766    0.081544    0.055085   -0.034917   -0.612964   -0.014668   -0.612156
 44:    95979    0.768814    0.082204   -0.015345    0.008350   -0.627327   -0.015564   -0.627566
 45:   146660    0.893315    0.085186   -0.063794    0.039775   -0.641829   -0.014424   -0.642749
 46:   148095    0.895625    0.086094   -0.024292    0.014654   -0.657371   -0.015377   -0.657745
 47:   204704    0.956000    0.079470   -0.029683    0.018923   -0.671336   -0.012781   -0.671716
 48:   252446    0.978764    0.077119    0.037408   -0.026495   -0.684067   -0.011966   -0.683619
 49:   327094    0.993202    0.081601   -0.003864    0.001576   -0.696860   -0.013685   -0.696913
 50:   376558    0.996804    0.080990   -0.023720    0.015776   -0.709607   -0.013128   -0.709919
 51:   425167    0.998478    0.086373   -0.097667    0.069577   -0.721342   -0.011389   -0.722455
 52:   285106    0.987098    0.092748   -0.077839    0.056061   -0.733367   -0.011799   -0.734285
 53:   228014    0.969169    0.082384   -0.053528    0.039018   -0.744644   -0.010582   -0.745210
 54:   196940    0.950466    0.090109   -0.032947    0.023830   -0.756104   -0.012144   -0.756504
 55:   113274    0.822438    0.104374   -0.204567    0.155905   -0.764973   -0.009334   -0.766882
 56:     5711    0.083455    0.131424   -0.221360    0.170497   -0.773811   -0.009624   -0.775941
 57:      518    0.007873    0.174893   -0.406761    0.317371   -0.780300   -0.002548   -0.781336
```

With truncated file:
```
$ ./fpm-test gpsdo.trunc.csv 
loaded 19991 data samples

biasI: 0.000823 ppm
biasF: 0.000806 ppm
rmseI: 0.002738 ppm (0.011614 ppm) [0]
rmseF: 0.002731 ppm (0.011597 ppm) [0]

fixed point math:
Temp.   Count        Norm       X * X       X * 1       Y * X       Y * 1           m           b
 49:      557    0.004232    0.101188    0.115417   -0.081464   -0.696306   -0.012493   -0.694850
 50:     4480    0.033038    0.070090    0.020096   -0.015202   -0.708448   -0.013853   -0.708162
 51:     4191    0.030975    0.089283   -0.104263    0.074230   -0.719966   -0.010662   -0.721058
 52:     1679    0.012647    0.083404   -0.053757    0.038395   -0.732524   -0.012213   -0.733174
 53:     3382    0.025149    0.073605    0.062912   -0.047692   -0.745316   -0.011531   -0.744588
 54:     3894    0.028844    0.089569   -0.052628    0.038578   -0.755638   -0.013703   -0.756340
 55:     1808    0.013606    0.118510   -0.300018    0.229039   -0.763854   -0.004593   -0.765232

floating point math:
Temp.   Count        Norm       X * X       X * 1       Y * X       Y * 1           m           b
 49:      557    0.008463    0.101726    0.117260   -0.082737   -0.696330   -0.012339   -0.694883
 50:     4480    0.066076    0.070276    0.021744   -0.016362   -0.708451   -0.013716   -0.708153
 51:     4191    0.061948    0.089123   -0.102753    0.073138   -0.719990   -0.010732   -0.721093
 52:     1679    0.025294    0.083437   -0.052212    0.037261   -0.732528   -0.012209   -0.733166
 53:     3382    0.050297    0.073934    0.064591   -0.048940   -0.745335   -0.011444   -0.744596
 54:     3894    0.057687    0.089593   -0.051071    0.037397   -0.755655   -0.013733   -0.756356
 55:     1808    0.027211    0.117783   -0.298632    0.227968   -0.763873   -0.005189   -0.765423
```
